# Automated Test Execution - Configuration Guide

## Overview

FirstQA now includes **AI-powered automated test execution** using Playwright. When a PR is opened, Ovi AI:
1. Generates a comprehensive test recipe
2. Converts test steps to Playwright browser automation
3. Executes tests in a real browser
4. Records video of the entire test run
5. Takes screenshots of each test scenario
6. Reports results via GitHub Checks API and detailed PR comments

## Features

‚úÖ **AI-Powered Test Generation** - Natural language test recipes converted to executable tests  
‚úÖ **Real Browser Testing** - Tests run in actual Chrome browser using Playwright  
‚úÖ **Video Recording** - Full test run recorded with timestamps for each scenario  
‚úÖ **Screenshot Capture** - Every test scenario gets a screenshot (pass or fail)  
‚úÖ **GitHub Checks Integration** - Test status appears in PR checks tab  
‚úÖ **Detailed Reports** - Rich PR comments with results, videos, and screenshots  
‚úÖ **Async Execution** - Tests run in background, don't block PR analysis  

## Configuration

### Environment Variables

Add these to your `.env` file:

```bash
# ============================================
# AUTOMATED TESTING CONFIGURATION
# ============================================

# Enable or disable automated testing
TEST_AUTOMATION_ENABLED=true

# Base URL of your staging/test environment
# This is where tests will run
TEST_AUTOMATION_BASE_URL=https://staging.yourdomain.com

# Optional: Only run tests on PRs with specific labels
# Comma-separated list of labels (leave empty to run on all PRs)
TEST_AUTOMATION_TRIGGER_LABELS=automated-test,qa-required

# Browser settings
TEST_AUTOMATION_HEADLESS=true          # Run browser in headless mode
TEST_AUTOMATION_SLOW_MO=100            # Slow down browser actions by N ms
TEST_AUTOMATION_TIMEOUT=30000          # Default timeout for actions (ms)

# Recording settings
TEST_AUTOMATION_RECORD_VIDEO=true      # Record full test run
TEST_AUTOMATION_SCREENSHOTS=true       # Take screenshots of each test

# GitHub App credentials (required for Checks API)
GITHUB_APP_ID=your-app-id
GITHUB_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\n...\n-----END RSA PRIVATE KEY-----"
```

### Quick Setup Examples

#### 1. Enable for All PRs
```bash
TEST_AUTOMATION_ENABLED=true
TEST_AUTOMATION_BASE_URL=https://staging.yourdomain.com
```

#### 2. Enable Only for PRs with Label
```bash
TEST_AUTOMATION_ENABLED=true
TEST_AUTOMATION_BASE_URL=https://staging.yourdomain.com
TEST_AUTOMATION_TRIGGER_LABELS=run-automated-tests
```

#### 3. Disable Automated Testing
```bash
TEST_AUTOMATION_ENABLED=false
# Or simply don't set the variable
```

## How It Works

### 1. PR Opened
When a PR is opened (and not in draft mode):
- Ovi AI analyzes the PR and generates a test recipe
- If `TEST_AUTOMATION_ENABLED=true`, automated testing is triggered

### 2. Test Execution
- GitHub Check Run is created (shows "in progress" in PR)
- Playwright launches a browser
- AI converts each test step to browser actions
- Tests execute one by one
- Video records the entire session
- Screenshots captured for each scenario

### 3. Results Reporting
- GitHub Check Run updated with pass/fail status
- Detailed PR comment posted with:
  - Summary table (passed/failed/skipped)
  - Full video with timestamps
  - Screenshots for each test
  - Detailed failure information
  - Console logs and network errors
  - Actionable recommendations

## Example Test Flow

### Test Recipe (Generated by AI)
```json
{
  "scenario": "User login with valid credentials",
  "priority": "Happy Path",
  "steps": "1. Navigate to /login\n2. Enter email: test@example.com\n3. Enter password: password123\n4. Click Login button",
  "expected": "User is redirected to dashboard and sees Welcome message"
}
```

### Converted to Playwright Actions (by AI)
```javascript
[
  {"type": "navigate", "url": "/login"},
  {"type": "type", "selector": "input[name='email']", "value": "test@example.com"},
  {"type": "type", "selector": "input[name='password']", "value": "password123"},
  {"type": "click", "selector": "button:has-text('Login')"},
  {"type": "wait", "condition": "navigation"},
  {"type": "verify", "assertion": "page contains Welcome"}
]
```

### Result
- ‚úÖ Test passes if dashboard loads with Welcome message
- ‚ùå Test fails if redirect doesn't happen or Welcome message missing
- Screenshot and video timestamp recorded either way

## GitHub Comment Example

```markdown
## ü§ñ Ovi AI - Automated Test Execution Results

![All Tests Passed](badge) ![Pass Rate](badge)

**Test Run:** #a1b2c3d4 | **Duration:** 3m 24s | **Browser:** Chromium

### Summary
| Status | Count | Percentage |
|--------|-------|------------|
| ‚úÖ Passed | 12 | 86% |
| ‚ùå Failed | 2 | 14% |
| Total | 14 | 100% |

### üé• Test Execution Video
[üìπ Watch Full Test Run](video-url)

**Jump to specific tests:**
- [‚úÖ User login with valid credentials](video#t=0) (00:00 - 00:05)
- [‚ùå Password validation](video#t=5) (00:05 - 00:08)
...

### Test Results by Priority
[Detailed tables with screenshots]

### ‚ùå Failed Test Details
[Detailed failure information with screenshots, console logs, network errors]
```

## GitHub Checks Integration

In the PR Checks tab, you'll see:
- **Ovi AI - Automated Tests** check
- ‚úÖ Green checkmark if all tests pass
- ‚ùå Red X if any tests fail
- Click for detailed breakdown by priority
- Annotations on failed tests with error details

## Staging Environment Requirements

Your staging environment should:
1. Be publicly accessible (or accessible from your server)
2. Have test data pre-loaded
3. Be stable and consistently available
4. Match production functionality

## Troubleshooting

### Tests Not Running
- Check `TEST_AUTOMATION_ENABLED=true` is set
- Verify `TEST_AUTOMATION_BASE_URL` is accessible
- Check if PR has required label (if `TEST_AUTOMATION_TRIGGER_LABELS` is set)
- Review logs for "‚è≠Ô∏è Test automation is disabled" messages

### Tests Failing
- Check staging environment is up
- Verify test data exists in staging
- Review video recording to see what happened
- Check console logs in failed test details
- Ensure selectors match your actual UI

### Videos/Screenshots Not Uploading
- Check `TEST_AUTOMATION_RECORD_VIDEO=true`
- Check `TEST_AUTOMATION_SCREENSHOTS=true`
- Verify disk space for storing files
- Review error logs for upload failures

### GitHub Checks Not Appearing
- Verify `GITHUB_APP_ID` and `GITHUB_PRIVATE_KEY` are set
- Check GitHub App has `checks:write` permission
- Review logs for "Error creating Check Run" messages

## Advanced Configuration

### Custom Test Selectors
Playwright uses smart selectors by default:
1. `data-testid` attributes (recommended)
2. `aria-label` attributes
3. Text content
4. CSS selectors

Add `data-testid` to your HTML for more reliable tests:
```html
<button data-testid="login-button">Login</button>
```

### Test Data Management
Create test accounts in staging:
- `test@example.com` / `password123`
- Ensure consistent test data
- Reset data periodically if needed

### Performance Tuning
```bash
# Speed up tests (less waiting)
TEST_AUTOMATION_SLOW_MO=0
TEST_AUTOMATION_TIMEOUT=10000

# Slow down for debugging
TEST_AUTOMATION_SLOW_MO=500
TEST_AUTOMATION_HEADLESS=false  # See browser window
```

## Cost Considerations

- **Playwright**: Free, open source
- **OpenAI API**: Uses GPT-4o for test conversion and verification (~$0.01-0.05 per PR)
- **Storage**: Videos and screenshots stored locally (can configure cloud storage)
- **Server**: Runs on your existing server, no additional hosting costs

## Roadmap

Future enhancements:
- [ ] Parallel test execution
- [ ] Multiple browser support (Firefox, Safari)
- [ ] Mobile device testing
- [ ] Visual regression testing
- [ ] Performance metrics
- [ ] Test report dashboard
- [ ] Cloud storage for videos/screenshots (S3, CloudFlare R2)

## Support

For issues or questions:
- Check logs with `npm start`
- Review PR comments for error details
- Watch video recordings to debug failures
- Contact FirstQA support

---

**Powered by Ovi AI + Playwright** ü§ñ

