<%- include('../partials/header') %>

<div class="container py-5">
  <div class="row mb-4">
    <div class="col-md-8">
      <h1 class="display-6 fw-bold">Test Requests</h1>
      <p class="text-muted">View and manage all testing requests</p>
    </div>
    <div class="col-md-4 text-md-end">
      <% if (user && user.role === 'developer') { %>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newRequestModal">
          <i class="bi bi-plus-circle me-2"></i>New Request
        </button>
      <% } %>
      <a href="/dashboard" class="btn btn-outline-secondary ms-2">
        <i class="bi bi-arrow-left me-2"></i>Back
      </a>
    </div>
  </div>

  <!-- Filter and Search -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label for="statusFilter" class="form-label">Status</label>
          <select class="form-select" id="statusFilter">
            <option value="all" selected>All Statuses</option>
            <option value="pending">Pending</option>
            <option value="assigned">Assigned</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="canceled">Canceled</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="sortBy" class="form-label">Sort By</label>
          <select class="form-select" id="sortBy">
            <option value="created_desc" selected>Newest First</option>
            <option value="created_asc">Oldest First</option>
            <option value="priority_desc">Priority (High to Low)</option>
            <option value="priority_asc">Priority (Low to High)</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="searchRequests" class="form-label">Search</label>
          <div class="input-group">
            <input type="text" class="form-control" id="searchRequests" placeholder="Search requests...">
            <button class="btn btn-outline-primary" type="button">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Requests List -->
  <div class="card shadow-sm">
    <div class="card-header bg-white">
      <h5 class="mb-0">All Requests</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Project</th>
              <% if (user && (user.role === 'admin' || user.role === 'tester')) { %>
                <th>Developer</th>
              <% } %>
              <% if (user && (user.role === 'admin' || user.role === 'developer')) { %>
                <th>Assigned Tester</th>
              <% } %>
              <th>Created</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="requestsTableBody">
            <!-- Sample Data - Will be replaced by actual data -->
            <tr>
              <td>
                <strong>User Authentication</strong>
                <div class="small text-muted">PR #1242</div>
              </td>
              <% if (user && (user.role === 'admin' || user.role === 'tester')) { %>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar avatar-sm me-2 bg-primary">JD</div>
                    John Developer
                  </div>
                </td>
              <% } %>
              <% if (user && (user.role === 'admin' || user.role === 'developer')) { %>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar avatar-sm me-2 bg-success">TS</div>
                    Tim Smith
                  </div>
                </td>
              <% } %>
              <td>May 25, 2023</td>
              <td><span class="badge bg-danger">High</span></td>
              <td><span class="badge bg-warning">In Progress</span></td>
              <td>
                <div class="btn-group">
                  <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Actions
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#"><i class="bi bi-eye me-2"></i>View Details</a></li>
                    <% if (user && user.role === 'admin') { %>
                      <li><a class="dropdown-item" href="#"><i class="bi bi-person-check me-2"></i>Assign Tester</a></li>
                    <% } %>
                    <% if (user && user.role === 'tester') { %>
                      <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-text me-2"></i>Submit Report</a></li>
                    <% } %>
                    <% if (user && (user.role === 'admin' || user.role === 'developer')) { %>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-x-circle me-2"></i>Cancel Request</a></li>
                    <% } %>
                  </ul>
                </div>
              </td>
            </tr>
            <tr>
              <td>
                <strong>Shopping Cart</strong>
                <div class="small text-muted">PR #1230</div>
              </td>
              <% if (user && (user.role === 'admin' || user.role === 'tester')) { %>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar avatar-sm me-2 bg-info">AJ</div>
                    Amy Johnson
                  </div>
                </td>
              <% } %>
              <% if (user && (user.role === 'admin' || user.role === 'developer')) { %>
                <td>
                  <span class="text-muted">Not assigned</span>
                </td>
              <% } %>
              <td>May 23, 2023</td>
              <td><span class="badge bg-warning">Medium</span></td>
              <td><span class="badge bg-secondary">Pending</span></td>
              <td>
                <div class="btn-group">
                  <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Actions
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#"><i class="bi bi-eye me-2"></i>View Details</a></li>
                    <% if (user && user.role === 'admin') { %>
                      <li><a class="dropdown-item" href="#"><i class="bi bi-person-check me-2"></i>Assign Tester</a></li>
                    <% } %>
                    <% if (user && user.role === 'developer') { %>
                      <li><a class="dropdown-item" href="#"><i class="bi bi-pencil me-2"></i>Edit Request</a></li>
                    <% } %>
                    <% if (user && (user.role === 'admin' || user.role === 'developer')) { %>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-x-circle me-2"></i>Cancel Request</a></li>
                    <% } %>
                  </ul>
                </div>
              </td>
            </tr>
            <tr>
              <td>
                <strong>Product Search</strong>
                <div class="small text-muted">PR #1220</div>
              </td>
              <% if (user && (user.role === 'admin' || user.role === 'tester')) { %>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar avatar-sm me-2 bg-warning">RB</div>
                    Rick Brown
                  </div>
                </td>
              <% } %>
              <% if (user && (user.role === 'admin' || user.role === 'developer')) { %>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar avatar-sm me-2 bg-danger">LW</div>
                    Lucy Wang
                  </div>
                </td>
              <% } %>
              <td>May 18, 2023</td>
              <td><span class="badge bg-success">Low</span></td>
              <td><span class="badge bg-success">Completed</span></td>
              <td>
                <div class="btn-group">
                  <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Actions
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#"><i class="bi bi-eye me-2"></i>View Details</a></li>
                    <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-text me-2"></i>View Report</a></li>
                  </ul>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer bg-white">
      <nav aria-label="Requests pagination">
        <ul class="pagination justify-content-center mb-0">
          <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
          </li>
          <li class="page-item active"><a class="page-link" href="#">1</a></li>
          <li class="page-item"><a class="page-link" href="#">2</a></li>
          <li class="page-item"><a class="page-link" href="#">3</a></li>
          <li class="page-item">
            <a class="page-link" href="#">Next</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- New Request Modal (for developers only) -->
<% if (user && user.role === 'developer') { %>
<div class="modal fade" id="newRequestModal" tabindex="-1" aria-labelledby="newRequestModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newRequestModalLabel">New Test Request</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="newRequestForm">
          <div class="mb-3">
            <label for="projectName" class="form-label">Project Name</label>
            <input type="text" class="form-control" id="projectName" required>
          </div>
          <div class="mb-3">
            <label for="repoUrl" class="form-label">Repository URL</label>
            <input type="url" class="form-control" id="repoUrl" required>
          </div>
          <div class="mb-3">
            <label for="pullRequestUrl" class="form-label">Pull Request URL</label>
            <input type="url" class="form-control" id="pullRequestUrl" required>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" rows="3" required></textarea>
            <div class="form-text">Include details about what to test and any specific requirements.</div>
          </div>
          <div class="mb-3">
            <label for="testType" class="form-label">Test Type</label>
            <select class="form-select" id="testType" required>
              <option value="" selected disabled>Select test type</option>
              <option value="functionality">Functionality</option>
              <option value="usability">Usability</option>
              <option value="compatibility">Compatibility</option>
              <option value="performance">Performance</option>
              <option value="security">Security</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="priority" class="form-label">Priority</label>
            <select class="form-select" id="priority" required>
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="critical">Critical</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitRequest">Submit Request</button>
      </div>
    </div>
  </div>
</div>
<% } %>

<!-- View Request Details Modal -->
<div class="modal fade" id="viewRequestModal" tabindex="-1" aria-labelledby="viewRequestModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewRequestModalLabel">Request Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="requestDetailsContent">
        <!-- Content will be loaded dynamically -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Assign Tester Modal (for admins only) -->
<% if (user && user.role === 'admin') { %>
<div class="modal fade" id="assignTesterModal" tabindex="-1" aria-labelledby="assignTesterModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="assignTesterModalLabel">Assign Tester</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="assignTesterForm">
          <input type="hidden" id="requestId" value="">
          <div class="mb-3">
            <label for="testerId" class="form-label">Select Tester</label>
            <select class="form-select" id="testerId" required>
              <option value="" selected disabled>Choose a tester...</option>
              <!-- Sample data - Will be populated dynamically -->
              <option value="1">Tim Smith (Available)</option>
              <option value="2">Lucy Wang (Available)</option>
              <option value="3">Alex Brown (Busy)</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="assignmentNotes" class="form-label">Notes for Tester (Optional)</label>
            <textarea class="form-control" id="assignmentNotes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmAssignment">Assign</button>
      </div>
    </div>
  </div>
</div>
<% } %>

<script>
  // This will be replaced with actual JavaScript code to handle requests
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize filter listeners
    const statusFilter = document.getElementById('statusFilter');
    const sortBy = document.getElementById('sortBy');
    const searchInput = document.getElementById('searchRequests');
    
    // Add event listeners for filters
    if (statusFilter) {
      statusFilter.addEventListener('change', function() {
        // Filter requests by status
        console.log('Filter by status:', this.value);
        // fetchRequests() with appropriate filters
      });
    }
    
    if (sortBy) {
      sortBy.addEventListener('change', function() {
        // Sort requests
        console.log('Sort by:', this.value);
        // fetchRequests() with appropriate sort
      });
    }
    
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        // Debounced search
        clearTimeout(this.timer);
        this.timer = setTimeout(() => {
          console.log('Search term:', this.value);
          // fetchRequests() with search term
        }, 300);
      });
    }
    
    // Handle new request form submission
    const submitRequestBtn = document.getElementById('submitRequest');
    if (submitRequestBtn) {
      submitRequestBtn.addEventListener('click', function() {
        // Validate and submit the form
        const form = document.getElementById('newRequestForm');
        if (form.checkValidity()) {
          console.log('Submitting request...');
          // Collect form data and submit
          const modal = bootstrap.Modal.getInstance(document.getElementById('newRequestModal'));
          modal.hide();
          // Show success message
        } else {
          form.reportValidity();
        }
      });
    }
    
    // Initial request fetch
    // fetchRequests();
  });
  
  // Function to fetch requests from API
  function fetchRequests(filters = {}) {
    // TODO: Implement API call to get requests
    console.log('Fetching requests with filters:', filters);
    // Update the table with received data
  }
</script>

<%- include('../partials/footer') %> 